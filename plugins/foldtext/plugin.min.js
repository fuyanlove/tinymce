tinymce.PluginManager.add("foldtext", function (editor, url) {

    var insertFoldText = function () {
        var selected_text = editor.selection.getContent();
        let _title = '<div class="e-summary">折叠头文本</div>';
        let _body = `<div class="e-details">被折叠区域文本</div><br>${selected_text}`;
        editor.insertContent(_title + _body);
    }

    // 注册一个工具栏按钮名称
    editor.ui.registry.addButton("foldtext", {
        icon: "foldtext",
        tooltip: "插入折叠文本",
        onAction: function () {
            insertFoldText()
        },
    });

    // 注册一个菜单项名称 menu/menubar
    // editor.ui.registry.addMenuItem("videox", {
    //     text: "Example菜单名",
    //     onAction: function () {
    //         openDialog();
    //     },
    // });

    // 监听keydown事件
    editor.on('keydown', function (e) {
        if (e.key === 'Enter') {
            var node = editor.selection.getNode();
            if (node && node.closest('.e-details')) {
                // 阻止在e-details内的回车行为
                e.preventDefault();

                // 插入p标签
                editor.insertContent('<p></p>');

                // 获取当前选区
                var range = editor.selection.getRng();
                var newP = range.startContainer.nextSibling;

                // 确保newP存在且是<p>标签
                if (newP && newP.nodeName === 'P') {
                    range.setStart(newP, 0);
                    range.setEnd(newP, 0);
                    editor.selection.setRng(range);
                }

                // 强制更新内容
                editor.nodeChanged();
            }

            // // 获取当前选区
            // var range = editor.selection.getRng();
            // var br = document.createElement('br');

            // // 插入br标签并移动光标
            // range.insertNode(br);

            // // 强制更新内容
            // editor.nodeChanged();

            // // 创建新的选区，将光标放到br标签后面
            // range.setStartAfter(br);
            // range.setEndAfter(br);

            // // 更新选区
            // editor.selection.setRng(range);

        }
    });

    return {
        getMetadata: function () {
            return {
                //插件名和链接会显示在“帮助”→“插件”→“已安装的插件”中
                name: "foldtext", //插件名称
                url: "https://github.com/fuyanlove", //作者网址
            };
        },
    };
});
